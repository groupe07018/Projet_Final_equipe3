{{!-- facture faite selon les données de la BD quand un chantier est terminé. Prévoir ensuite pouvoir archiver ce chantier 
pour le supprimer de la liste des chantiers en cours --}}
<form><div class="grid-container">
    <div class="grid-item-1">
        <h1>Facture</h1>
        No facture {{id_chantier}}<br>
        <span class="sousTexte">
            Date: <input type="date" name="date" required><br>
            Échéance <br><br>
        </span>
    </div>
    <div class="grid-item-3">
        <p class="coordonneesNom">
        <strong>Céramique David Laroche</strong><br>
        3012 Anctil, St-Denis-deBrompton, QC<br>
        819-222-2222<br>
        <span class="sousTexte">
        TPS: 33333333444 TVQ: 333333444444<br>
        RBQ: 22222222222</span>
        </p>
    </div>
    <div class="grid-item-4">
        <strong>Facturé à:</strong> <br>
    
    </div>
    <div class="grid-item-6">
        <strong>Travaux effectués au:</strong><br>

        <select name="menu_chantierActif" class="sansContour" onclick="afficherChantier(this)" required>
                <option value="">Choisir</option>
                    {{#each chantierActif}},
                        <option class="sansContour" value="{{this.id}}">{{this.nom_projet}}, {{this.adresse}}, {{this.nom_ville}}, {{this.code_postal}}</option>
                    {{/each}}
        </select> 
    </div>
</div>
<br>
<table id="tableFacture" class="table table-striped">
    
        <tr class="table-secondary">
            <th>Description</th>
            <th>Taux</th>
            <th>Quantité</th>{{!-- faire les calculs dans le fichier script.js, en appelant la function avec le input de quantité --}}
            <th>Sous-total</th>
        </tr>
        <tr>
            <td><button type="button" class="btn btn-primary" onclick="ajoutLigne()">Ajouter un frais</button> </td>
            <td></td>
            <td></td>
            <td></td>
        </tr>
        <tr>
            <td>Heures facturables</td>
            <td><input type="number" class="caseQuantite" id="tauxHoraire" placeholder="requis" required onkeyup="calculHeure()"></td>
            <td><input type="number" value="10" class="caseQuantite" id="heureFacturable" placeholder="requis"  onkeyup="calculHeure()" required ></td> <!--aller chercher value dans la BD)-->
            <td><span id="afficherSousTotalHeure"></span></td>
        </tr>
        <td><select name="menu_frais_fixe" required onchange="afficherPrix(this)">
                    <option value="">- Sélectionner -</option>
                    {{#each frais_fixe}}
                        <option value="{{this.prix_frais_fixe}}">{{this.nom_frais_fixe}} {{this.prix_frais_fixe}}$ / {{this.unite_frais_fixe}}</option>
                    {{/each}}
                </select> 
            </td>
            <td></td>
            <td><input defaultValue="0" class="caseQuantite" type="number" id="quantite" name="quantite" required="true" placeholder="requis">test</td>
            <td></td>
</table>
<table id="tableTotal" class="table">
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>Sous-total</td>
            <td><span id="sousTotalFinal"></span></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>TPS</td>
            <td id="tps"></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>TVQ</td>
            <td id="tvq"></td>
        </tr>
        <tr>
            <td></td>
            <td></td>
            <td></td>
            <td>Total</td>
            <td id="totalFinal"></td>
        </tr> 
</table>

<div class="grid-container">
    <div class="grid-item-6">
        <button type="submit" class="btn btn-primary">Enregister et archiver ce chantier</button>  
        <button type="button" onclick="window.print()" class="btn btn-danger">Imprimer</button>
    </div>
</div>
</form>

<script>
var sousTotalHeure = 0; //utiliser pour le calcul final

function Recup_select_info(menu, selection){
    var index = menu.selectedIndex;

    if((selection) && (selection == 'valeur')){
        return menu.options[index].value;}
    else{ 
        return index;}
}
 
function calculHeure(){
    let heureFacturable = document.querySelector("#heureFacturable").value
    let tauxHoraire = document.querySelector('#tauxHoraire').value
    let afficherSousTotalHeure = document.querySelector("#afficherSousTotalHeure")
    tauxHoraire = Number(tauxHoraire)
    heureFacturable = Number(heureFacturable)
    totalHeure = heureFacturable * tauxHoraire 

    afficherSousTotalHeure.innerHTML = totalHeure.toFixed(2)
    sousTotalHeure = totalHeure
    calculSousTotalFinal()
} 

function afficherPrix(menu){
    let valeur_prix = Recup_select_info(menu,'valeur');
    let parentMenu = menu.parentElement// donne le td du menu (parent du select)
    let frereMenu = parentMenu.nextElementSibling // donne le td du prix (sibling du TD du menu)
    valeur_prix = Number(valeur_prix)
    frereMenu.innerHTML= valeur_prix.toFixed(2)
    calculFraisFixes(menu)
}

function calculFraisFixes(menu){
    let valeur_prix = Recup_select_info(menu,'valeur'); // ok
    let parentMenu = menu.parentElement// donne le td du menu (parent du select)
    let frereMenu = parentMenu.nextElementSibling // donne le td du prix (sibling du TD du menu)
    let frerePrix = frereMenu.nextElementSibling // donne le td de la quantité (sibling TD prix)
    let valeurQuantite = frerePrix.firstElementChild.tagName// donne le input de la quantité
    console.log(valeurQuantite.value)//marche pas, toute facon, le call de la function est pas bon
}

function calculSousTotalFinal(){
    afficherSousTotalFinal = document.querySelector("#sousTotalFinal")
    afficherTotalFinal = document.querySelector("#totalFinal")
    sousTotalFinal = sousTotalHeure //+ ajouter les autres sous-totaux frais fixe
    afficherSousTotalFinal.innerHTML = sousTotalFinal.toFixed(2)
    calculTaxe(sousTotalFinal)
}

function calculTaxe(x){
    let tps = document.querySelector("#tps")
    let tvq = document.querySelector("#tvq")
    let calculTPS = ((x*5)/100);
    let calculTVQ = ((x*9.975)/100);
    let montantTxIn = (x + calculTPS + calculTVQ).toFixed(2);
    tps.innerHTML = calculTPS.toFixed(2)
    tvq.innerHTML = calculTVQ.toFixed(2)

    afficherTotalFinal.innerHTML = montantTxIn
}

function afficherChantier(menu_chantier){
    var info_chantier = Recup_select_info(menu_chantier, 'valeur');
    console.log(info_chantier)// affiche le id du chantier sélectionné. COmment le passer à l'url?
    /*document.querySelector("menu_chantierActif")[0].addEventListener("click", function(event) {
    event.target.setAttribute("href", "/chantier=" + info_chantier);
})*/;
    
}

function ajoutLigne(){
    var table = document.querySelector("#tableFacture");
    var row = table.insertRow(-1);

    row.innerHTML = `<td><select name="menu_frais_fixe" required onchange="afficherPrix(this)">
                    <option value="">- Sélectionner -</option>
                    {{#each frais_fixe}}
                        <option value="{{this.prix_frais_fixe}}">{{this.nom_frais_fixe}} {{this.prix_frais_fixe}}$ / {{this.unite_frais_fixe}}</option>
                    {{/each}}
                </select> 
            </td>
            <td><span id="prixFacture">0.00</span></td>
            <td><input class="caseQuantite" type="number" id="quantite" name="quantite" required="true" placeholder="requis"></td>
            <td></td>`
}
</script>